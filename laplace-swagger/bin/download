#!/usr/bin/env node
/* eslint-disable @typescript-eslint/no-var-requires */
const { createWriteStream } = require('fs');
const axios = require('axios');

async function downloadFile(fileUrl, outputLocationPath) {
  return axios({
    method: 'get',
    url: fileUrl,
    responseType: 'stream',
  }).then(response => {
    return new Promise((resolve, reject) => {
      const writer = createWriteStream(outputLocationPath);
      response.data.pipe(writer);
      let error = null;
      writer.on('error', err => {
        error = err;
        writer.close();
        reject(err);
      });
      writer.on('close', () => {
        if (!error) {
          resolve(true);
        }
      });
    });
  });
}

if (process.argv.length !== 4) {
  console.error('Usage: ./download <url> <output-path>');
}

const url = process.argv[2];
const output = process.argv[3];
console.log(`Downloading ${url}`);
downloadFile(url, output).then(
  () => {
    console.log(`Saved ${url} to ${output}`);
    process.exit(0);
  },
  e => {
    console.error(`Fail to download file from ${url}, error: ${e}`);
    process.exit(1);
  },
);

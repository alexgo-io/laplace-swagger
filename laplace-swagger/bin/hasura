#!/usr/bin/env bash
set -e

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

pushd "$DIR" > /dev/null 2>&1 || exit
if [ ! -e "./docker/wait" ]; then
  mkdir -p ./docker
  wget -qO ./docker/wait https://github.com/ufoscout/docker-compose-wait/releases/download/2.9.0/wait
  chmod +x ./docker/wait
fi
popd > /dev/null 2>&1 || exit

_docker_compose() {
  pushd "$DIR/docker" >/dev/null 2>&1 || exit
  docker-compose --project-name laplace-dev \
    -f docker-compose.laplace-dev.yaml \
    $@
  popd >/dev/null 2>&1 || exit
}

main() {
  local cmd=$1
  case $cmd in
  up)
    _docker_compose up -d
    echo Local hasura console will be running at http://localhost:60880/console
    echo '    with admin secret: ed1dynCpdTreu5a'
    echo "If you're starting from fresh, run:"
    echo '    yarn use local && yarn hasura metadata apply && yarn hasura migrate apply --all-databases && yarn hasura metadata reload'
    echo "And if you need to see the replication status, run:"
    echo '    docker logs -f --tail=100 laplace_dev_replicator'
    ;;
  down)
    _docker_compose down
    ;;
  logs)
    _docker_compose logs -f --tail=100
    ;;
  clean)
    _docker_compose down
    docker volume rm laplace-dev_pgdata
    docker volume rm laplace-dev_replica
    ;;
  *)
    echo "Usage: $0 {up|down|logs|clean}"
    exit 1
    ;;
  esac
}

main $@
